<!DOCTYPE html>
<html>
<head>

  <!-- General -->
  <title>Bundeslandweite Betrachtung deutscher Forschung</title>
  <meta charset="utf-8">
  
  <!-- JSON-File for german states-->
  <script type="text/javascript" src="setupBundeslaenderData.js"></script>

  <!-- D3 -->
  <script src="https://d3js.org/d3.v3.min.js"></script>

  <!-- Radar-Chart -->
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>Smoothed D3.js Radar Chart</title>
  <!-- Google fonts -->
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <script src="./radarChart.js"></script>

  <!--  bundeslaenderData (calculated with gepris-data) -->
  <script type="text/javascript" src="bundeslaenderData.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="d3-projekt.css">

</head>

</body>

  <div class="flex-container-germany-visu">
  
    <!-- row 1 -->
    <div class="flex-child-germany-visu container-germany-map">
      <!-- col 1-->
      <div class="filter">
        <!-- Filter: Axis -->
        <div class="flex-container-axis">
          <div class="flex-child-axis active" id="axis-bip"         onclick="onclickHandlerAxis(this.id, 0)">BIP</div>
          <div class="flex-child-axis" id="axis-institute"          onclick="onclickHandlerAxis(this.id, 1)">Institute</div>
          <div class="flex-child-axis" id="axis-projekte"           onclick="onclickHandlerAxis(this.id, 2)">Projekte</div>
          <div class="flex-child-axis" id="axis-spezialisierungen"  onclick="onclickHandlerAxis(this.id, 3)">Spezialisierungen</div>
          <div class="flex-child-axis" id="axis-finanzierungsrate"  onclick="onclickHandlerAxis(this.id, 4)">Finanzierungsrate</div>
        </div>
      </div>
      <!-- col 2-->
      <div class="visualisation">
        <!-- Visu: germany-map-->
        <div class="germanyMap"></div>
      </div>

      <!-- col 3-->
      <div class="radio-buttons">sfd</div>
    </div>

    <!-- row 2 -->
    <div class="flex-child-germany-visu container-radar-chart">
      <!-- col 1-->
      <div class="filter">
        <!-- Filter: Axis -->
        <div class="flex-container-review-board">
          <div class="flex-child-review-board active" id="rb-alle"            onclick="onclickHandlerReviewBoard(this.id, 0)">Alle</div>
          <div class="flex-child-review-board" id="rb-informatik"             onclick="onclickHandlerReviewBoard(this.id, 1)"> Informatik</div>
          <div class="flex-child-review-board" id="rb-mathematik"             onclick="onclickHandlerReviewBoard(this.id, 2)">Mathematik</div>
          <div class="flex-child-review-board" id="rb-psychologie"            onclick="onclickHandlerReviewBoard(this.id, 3)">Psychologie</div>
          <div class="flex-child-review-board" id="rb-theologie"              onclick="onclickHandlerReviewBoard(this.id, 4)">Theologie</div>
          <div class="flex-child-review-board" id="rb-sprachwissenschaften"   onclick="onclickHandlerReviewBoard(this.id, 5)">Sprachwissenschaften</div>
        </div>
      </div>
      <!-- col 2-->
      <div class="visualisation">
        <!-- Visu: radar-chart-->
        <div class="radarChart"></div>
      </div>
      <!-- col 3-->
      <div class="radio-buttons">sfd</div>      
    </div>

  </div>



<script>

    /**********************************************************************************************/
    /****************************************[GLOBAL VARIABLES]************************************/
    /**********************************************************************************************/

    //////////////////////// Set-Up ////////////////////////////// 

    var margin = { top: 100, right: 100, bottom: 100, left: 100 },
      width = Math.min(700, window.innerWidth - 10) - margin.left - margin.right,
      height = Math.min(width, window.innerHeight - margin.top - margin.bottom - 20); 

    var color = d3.scale.ordinal()
      .range(["#EDC951", "#CC333F", "#00A0B0"]);

    var radarChartOptions = {
      w: width,
      h: height,
      margin: margin,
      maxValue: 0.5,
      levels: 5,
      roundStrokes: true,
      color: color
    };

    var data = bundeslaenderObjectData;
    var i_bundesland = 0;
    var i_reviewBoard = 0;
    var i_axis = 0;

  /**********************************************************************************************/
  /******************************************[Load CSV-Files]************************************/
  /**********************************************************************************************/

  /*  to access files in my folder with d3.csv-function */
  const path = "../D3_Bundeslaender/";
  const csvBundeslaenderAlle = "EXPORT_D3_all.csv";
  const csvCompressedPercentage = "EXPORT_D3_compressed_percentage.csv";
  
  let csvSupportData = null;
  let csvData = null;
  const csvFileNames = [
    "EXPORT_D3_Mecklenburg_Vorpommern.csv",
    "EXPORT_D3_Schleswig_Holstein.csv",
    "EXPORT_D3_Niedersachsen.csv",
    "EXPORT_D3_Bremen.csv",

    "EXPORT_D3_Sachsen_Anhalt.csv",
    "EXPORT_D3_Brandenburg.csv",
    "EXPORT_D3_Berlin.csv",
    "EXPORT_D3_Nordrhein_Westfalen.csv",

    "EXPORT_D3_Hessen.csv",
    "EXPORT_D3_Thueringen.csv",
    "EXPORT_D3_Sachsen.csv",
    "EXPORT_D3_Rheinland_Pfalz.csv",

    "EXPORT_D3_Saarland.csv",
    "EXPORT_D3_Baden_Wuerttemberg.csv",
    "EXPORT_D3_Bayern.csv",
    "EXPORT_D3_Hamburg.csv",
  ];

  /*  store csv-file in variable  */
  let csvFilesNamesLen = csvFileNames.length;
  d3.csv(path + csvBundeslaenderAlle, 
      (supportData) => { 
        csvSupportData = initSupportData(supportData)
        console.log("[SUCCESS]  - initSupportData()")
      }
  );

  d3.csv(path + csvCompressedPercentage,
    (mainData) => {
      csvData = initBundeslaenderObjectData(mainData);
      console.log("[SUCCESS]  - csvData()")
      data = csvData;
    } 
  );
  
  /*  wait until csv-files are loaded */
  setTimeout( () => {
 

    //Call function to draw the Radar chart
    drawRadarChart();


    /**********************************************************************************************/
    /*********************************************[Germany Map]************************************/
    /**********************************************************************************************/
    var width = 960,
      height = 500,
      focused = null,
      geoPath;

    var svg = d3.select(".germanyMap")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height);

    var g = svg.append("g")
      .append("g")
      .attr("id", "states")

    d3.json("./bundeslaenderJSON.json", function (collection) {

      var bounds = d3.geo.bounds(collection),
        bottomLeft = bounds[0],
        topRight = bounds[1],
        rotLong = -(topRight[0] + bottomLeft[0]) / 2;
      center = [(topRight[0] + bottomLeft[0]) / 2 + rotLong, (topRight[1] + bottomLeft[1]) / 2],

        //default scale projection
        projection = d3.geo.albers()
          .parallels([bottomLeft[1], topRight[1]])
          .rotate([rotLong, 0, 0])
          .translate([width / 2, height / 2])
          .center(center),

        bottomLeftPx = projection(bottomLeft),
        topRightPx = projection(topRight),
        scaleFactor = 1.00 * Math.min(width / (topRightPx[0] - bottomLeftPx[0]), height / (-topRightPx[1] + bottomLeftPx[1])),

        projection = d3.geo.albers()
          .parallels([bottomLeft[1], topRight[1]])
          .rotate([rotLong, 0, 0])
          .translate([width / 2, height / 2])
          .scale(scaleFactor * 0.975 * 1000)
          //.scale(4*1000)  //1000 is default for USA map
          .center(center);

      geoPath = d3.geo.path().projection(projection);

      var graticule = d3.geo.graticule()
        .step([1, 1]);

      g.append("path")
        .datum(graticule)
        .attr("class", "graticuleLine")
        .attr("d", geoPath);

      /*  [NEW]   [EXPLANATION]
       *  Access to german-states-rect 
       *
       */

      g.selectAll("path.feature")
        .data(collection.features)
        .enter()
        .append("path")
        .attr("class", "feature")
        .attr("d", geoPath)
        .on("click", changeVisualizations);

      // console.log("d3.json: bounds = " + bounds);
      // console.log("d3.json: bottomLeft = " + bottomLeft);
      // console.log("d3.json: topRight = " + topRight);
      // console.log("d3.json: center = " + center);
      // console.log("d3.json: projection(center) = " + projection(center));
      // console.log("d3.json: projection(bottomLeft) = " + projection(bottomLeft));
      // console.log("d3.json: projection(topRight) = " + projection(topRight));
      // console.log("d3.json: topRightPx = " + topRightPx);
      // console.log("d3.json: bottomLeftPx = " + bottomLeftPx);
      // console.log("d3.json: scaleFactor x axis = " + width / (topRightPx[0] - bottomLeftPx[0]));
      // console.log("d3.json: scaleFactor y axis = " + height / (-topRightPx[1] + bottomLeftPx[1]));
      // console.log("d3.json: scaleFactor = " + scaleFactor);
    });




    function clickPath(d) {

      var x = width / 2,
        y = height / 2,
        k = 1,
        name = d.properties.NAME_1;

      g.selectAll("text")
        .remove();
      if ((focused === null) || !(focused === d)) {
        var centroid = geoPath.centroid(d),
          x = +centroid[0],
          y = +centroid[1],
          k = 1.75;
        focused = d;

        g.append("text")
          .text(name)
          .attr("x", x)
          .attr("y", y)
          .style("text-anchor", "middle")
          .style("font-size", "8px")
          .style("stroke-width", "0px")
          .style("fill", "black")
          .style("font-family", "Times New Roman")
          .on("click", clickText);
      }
      else {
        focused = null;
      };

      g.selectAll("path")
        .classed("active", focused && function (d) { return d === focused; });

      g.transition()
        .duration(1000)
        .attr("transform", "translate(" + (width / 2) + "," + (height / 2) + ")scale(" + k + ")translate(" + (-x) + "," + (-y) + ")")
        .style("stroke-width", 1.75 / k + "px");
    }


    function clickText(d) {
      focused = null;
      g.selectAll("text")
        .remove();
      g.selectAll("path")
        .classed("active", 0);
      g.transition()
        .duration(1000)
        .attr("transform", "scale(" + 1 + ")translate(" + 0 + "," + 0 + ")")
        .style("stroke-width", 1.00 + "px");
    }


    /*==========================================================*/
    /*===============[Combine all ELements]=====================*/
    /*==========================================================*/
    function changeVisualizations(bundeslandJsonObject) {
      let currentBundesland = bundeslandJsonObject.properties.NAME_1;
      console.log(currentBundesland);
      data = csvData;

      /*  check if view is already focused 
      *  and update data for radardiagramm
      */
      if ((focused === null) || !(focused === bundeslandJsonObject)) {
        i_bundesland = mapBundeslandToNumber(currentBundesland);
      }
      else {
        data = csvData;
        i_bundesland = -1;
      }


      /*  update radardiagramm  */
      drawRadarChart();

      /* focus in germany-map */
      clickPath(bundeslandJsonObject);

    }

  }, 1000); // wait 1s till csv-data is loaded

/**********************************************************************************************/
/****************************************[BUTTON-FUNCTIONS]************************************/
/**********************************************************************************************/


                /*********************[REVIEW-BOARD BUTTONS]***********************/
/** 
  * onclick-function for review-board-buttons
  * 
  * 1)  update global variable i_reviewBoard
  * 2)  refresh germany-map
  * 3)  draw radarChart again
  */
  function onclickHandlerReviewBoard(id,index){
    changeReviewBoardIndex(id, index);
    defineGermanStateColor();
    drawRadarChart();
  }


/**
 *  change global i_reviewBoard
 */
function changeReviewBoardIndex(id,index){
  if(i_reviewBoard != index){
    i_reviewBoard = index;
    toggleReviewBoardActive(id);
  }
  return;
}

function toggleReviewBoardActive(id){
  let activeObj = document.getElementsByClassName("flex-child-review-board active");
  
  for(let i=0; i < activeObj.length; i++){
    activeObj[i].classList.remove("active")
  }
  let obj = document.getElementById(id);
  obj.classList.toggle("active");
}


                /****************************[AXIS BUTTONS]***********************/
/** 
  * onclick-function for axis-buttons
  * 
  * 1)  update global variable i_axis 
  * 2)  refresh germany-map
  */
function onclickHandlerAxis(id,index){
  changeAxisIndex(id,index);
  defineGermanStateColor();
}

/**
 *  change global i_axis
 */
 function changeAxisIndex(id,index){
  if(i_axis != index){
    i_axis = index;
    toggleAxisActive(id);
    drawRadarChart();
  }
  return;
}

function toggleAxisActive(id){
  let activeObj = document.getElementsByClassName("flex-child-axis active");
  
  for(let i=0; i < activeObj.length; i++){
    activeObj[i].classList.remove("active")
  }
  let obj = document.getElementById(id);
  obj.classList.toggle("active");
}


/**********************************************************************************************/
/****************************************[SUPPORT-FUNCTIONS]***********************************/
/**********************************************************************************************/
function drawRadarChart(){
  RadarChart(".radarChart", data,radarChartOptions, i_bundesland, i_reviewBoard);
}


/**
 *  defines color of german-states individually, based on entries in csv-data (value-array)
 *  based on review_board
 *  based on axis in radar-chart 
 */
function defineGermanStateColor(){
  /*  indizes   */
  let k_axis = i_axis;
  let k_review = i_reviewBoard;

  /*  color     */
  let COLOR_LIMITS = {
    RED   :{  min: 123, max: 0,   },
    GREEN :{  min: 185, max: 68,  },
    BLUE  :{  min: 220, max: 170, },
  }

  COLOR_LIMITS = {
    RED   :{  min: 123, max: 0,   difference : COLOR_LIMITS.RED.min - COLOR_LIMITS.RED.max },
    GREEN :{  min: 185, max: 68,  difference : COLOR_LIMITS.GREEN.min - COLOR_LIMITS.GREEN.max },
    BLUE  :{  min: 220, max: 170, difference : COLOR_LIMITS.BLUE.min - COLOR_LIMITS.BLUE.max },
  }

  let statesArray = document.getElementsByClassName("feature");

  for(let i=0; i<statesArray.length; i++){
    let bundeslandName = statesArray[i].__data__.properties.NAME_1;
    let i_bundesland = mapBundeslandToNumber(bundeslandName);

    /* calc color */
    const valuePercent_Between_0_And_1    =  data[i_bundesland][k_axis].value[k_review];
    const valuePercent_Between_1_And_100  =  valuePercent_Between_0_And_1 * 100;
    
    const valueRed = COLOR_LIMITS.RED.min - ( (COLOR_LIMITS.RED.difference/100) * valuePercent_Between_1_And_100 );
    const valueGreen = COLOR_LIMITS.GREEN.min - ( (COLOR_LIMITS.GREEN.difference/100) * valuePercent_Between_1_And_100 );
    const valueBlue = COLOR_LIMITS.BLUE.min - ( (COLOR_LIMITS.BLUE.difference/100) * valuePercent_Between_1_And_100 );

    let fill = "rgb("+valueRed+","+valueGreen+","+valueBlue+")"
    statesArray[i].style.fill = fill;
    // console.log("axis[" + i_axis + "]"
    //       +" reviewboard[" + i_review + "]: " 
    //       +" 0-1 - " + valuePercent_Between_0_And_1 + ", "
    //       +" 1-100 - " + valuePercent_Between_1_And_100 + ", "
    //       +" red " + valueRed + " "

    // )
  }

}

function mapBundeslandToNumber(name){
  let len = data.length;
  for(let i=0; i<len; i++){
    if(data[i][0].name == name){
      // console.log(name +": "+ i)
      return i;
    }
  }
  return -1;
}

</script>

</body>

</html>